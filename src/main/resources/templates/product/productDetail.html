<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/defaultLayout}">
      
	<head>
		<title>간식줘집사 상품 상세</title>
	</head>
	<section layout:fragment="contents" class="contents w-100">
		<div class="d-flex justify-content-between w-100">
			<article class="group-article background-cards-list">							
				<div class="groups-detail-product-current">					
<!-- 상단 메뉴들-->		<div class="group-upper-side-detail-product">
						<img class="image-detail-product" alt="image of product" th:src="${product.imgProfile}" width="450" height="450">
						<div class="group-right-upper-side-detail-product">
							<div class="title-upper-side-detail-product">
								<p th:text="${product.name}"></p>
							</div>
							<div class="title-quantity-available-current-detail-product">
								<p th:if="${product.quantityAvailable} > 0" th:text="'구매 가능 수량: ' + ${product.quantityAvailable}"></p>
								<p th:unless="${product.quantityAvailable} > 0" th:text="'판매 종료 되었습니다.'"></p>
							</div>
							<div class="title-price-current-detail-product">
								<p th:text="'￦ ' + ${product.price}"></p>
							</div>
							<div class="group-btns-cart-detail-product">
								<div class="btns-quantity-detail-product">
									<div class="group-btns-quantity-adjust">
<!-- 현재 물품 수량 추가 버튼 -->								
										<button id="btn-plus-quantity-current" class="btn-plus">
											<svg width="50" height="51" viewBox="0 0 50 51" fill="none" xmlns="http://www.w3.org/2000/svg">
												<g filter="url(#filter0_d_64_304)">
													<path fill-rule="evenodd" clip-rule="evenodd" d="M28 4.5C28 2.29086 26.2091 0.5 24 0.5C21.7909 0.5 20 2.29086 20 4.5V20.5H4C1.79086 20.5 0 22.2909 0 24.5C0 26.7091 1.79086 28.5 4 28.5H20L20 44.5C20 46.7091 21.7909 48.5 24 48.5C26.2091 48.5 28 46.7091 28 44.5L28 28.5H44C46.2091 28.5 48 26.7091 48 24.5C48 22.2909 46.2091 20.5 44 20.5H28V4.5Z" fill="#51C3ED"/>
												</g>
												<defs>
													<filter id="filter0_d_64_304" x="0" y="0.5" width="50" height="50" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
														<feFlood flood-opacity="0" result="BackgroundImageFix"/>
														<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
														<feOffset dx="2" dy="2"/>
														<feComposite in2="hardAlpha" operator="out"/>
														<feColorMatrix type="matrix" values="0 0 0 0 0.984314 0 0 0 0 0.666667 0 0 0 0 0.388235 0 0 0 1 0"/>
														<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_64_304"/>
														<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_64_304" result="shape"/>
													</filter>
												</defs>
											</svg>
										</button>
<!-- 수량 기입 버튼 -->
										<input id="count-order-product" class="input-count-order-product" type="number" th:data-price="${product.price}" value="0">
<!-- 현재 물품 수량 감소 버튼 -->									
										<button id="btn-minus-quantity-current"  class="btn-minus">
											<svg width="50" height="11" viewBox="0 0 50 11" fill="none" xmlns="http://www.w3.org/2000/svg">
												<g filter="url(#filter0_d_64_310)">
													<path d="M4 4.5H24H44" stroke="#FF6868" stroke-width="8" stroke-linecap="round"/>
												</g>
												<defs>
													<filter id="filter0_d_64_310" x="0" y="0.5" width="50" height="10" filterUnits="userSpaceOnUse" color-interpolation-filters="sRGB">
														<feFlood flood-opacity="0" result="BackgroundImageFix"/>
														<feColorMatrix in="SourceAlpha" type="matrix" values="0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 0 127 0" result="hardAlpha"/>
														<feOffset dx="2" dy="2"/>
														<feComposite in2="hardAlpha" operator="out"/>
														<feColorMatrix type="matrix" values="0 0 0 0 0.407843 0 0 0 0 1 0 0 0 0 0.635294 0 0 0 1 0"/>
														<feBlend mode="normal" in2="BackgroundImageFix" result="effect1_dropShadow_64_310"/>
														<feBlend mode="normal" in="SourceGraphic" in2="effect1_dropShadow_64_310" result="shape"/>
													</filter>
												</defs>
											</svg>
										</button>
									</div>
<!-- 장바구니 추가 버튼; 첫 번째-->
									<button class="btn-add-to-cart group-btn-add-to-cart" th:data-product-id="${product.id}">
										<div class="icon-cart mb-2">
											<svg width="22" height="22" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
												<path d="M20.0987 9.53246C20.7788 9.97842 21.7311 11.5011 20.0987 14.0239M20.0987 9.53246L16.5992 14.0239M20.0987 9.53246L17.865 9.53246M20.0987 14.0239H16.5992M20.0987 14.0239L17.8418 17.512M11.1639 21L13.8816 17.512M11.1639 21H15.5849L17.8418 17.512M11.1639 21V17.512M11.1639 21L8.35569 17.512M11.1639 21H6.59557L4.26346 17.512M13.8816 17.512L16.5992 14.0239M13.8816 17.512H11.1639M13.8816 17.512H17.8418M16.5992 14.0239H13.1167M11.1639 14.0239V9.53246M11.1639 14.0239H13.1167M11.1639 14.0239V17.512M11.1639 14.0239H9.14604M11.1639 9.53246H15.6313M11.1639 9.53246H6.54765M13.1167 14.0239L11.1639 17.512M13.1167 14.0239L15.6313 9.53246M11.1639 17.512H8.35569M11.1639 17.512L9.14604 14.0239M15.6313 9.53246L17.865 9.53246M1.93136 9.53246C1.22853 9.97842 0.244577 11.5011 1.93136 14.0239M1.93136 9.53246L5.54745 14.0239M1.93136 9.53246H6.54765M1.93136 14.0239H5.54745M1.93136 14.0239L4.26346 17.512M8.35569 17.512L5.54745 14.0239M8.35569 17.512H4.26346M5.54745 14.0239H9.14604M9.14604 14.0239L6.54765 9.53246M4.2395 9.53246C4.2395 2.54662 10.9456 2.65193 10.9456 2.65193C10.9456 2.65193 17.865 2.54663 17.865 9.53246M3.12266 9.53245C3.12266 3.22522 7.04732 0.994501 10.9456 1C14.8544 1.00551 18.7635 2.61491 18.7635 9.60075" stroke="white" stroke-width="1.5"/>
											</svg>
										</div>
										장바구니 추가
									</button>
								</div>
								<div class="btns-pay-or-not d-flex justify-content-start">
<!-- 해당 항목 결제 버튼; 바로 결제 페이지 넘어가야 -->
									<button class="btn-pay-product-current" th:data-product-id="${product.id}">
										해당 항목 결제
									</button>
<!-- 취소하기 버튼; 상품 리스트 페이지로 넘어가야 -->									
									<a class="btn-cancel-product-current ml-3" href="/product/product-list-view">
										취소하기
									</a>
								</div> <!--__end__ .btns-pay-or-not -->
							</div><!--__end__ .group-btns-cart-detail-product -->
						</div><!--__end__ .group-right-upper-side-detail-product -->
					</div><!--__end__ .group-upper-side-detail-product -->
					<div class="group-lower-side-detail-product"> 
					</div><!--__end__ .group-lower-side-detail-product -->
				</div><!--__end__ .groups-detail-product-current -->
<!-- 제품상세 내역 -->	
				<div class="groups-buttom-cart-total">
					<div class="group-cost-total-current">
						<div class="label-cost-total-current">
							전체
						</div>
						<div class="text-cost-total-current">
							<span id="cost-total-current" th:data-price="${product.price}">0</span>
							<span class="ml-2">원</span>
						</div>
					</div>
<!-- 장바구니 추가 버튼 하단; 두 번째 -->					
					<button class="btn-add-to-cart btn-add-to-cart-bottom"  th:data-product-id="${product.id}">
						장바구니 담기
					</button>
				</div>
			</article>
		</div>
	</section>

	<th:block layout:fragment="script">
    	<script th:inline="javascript">
    		$(document).ready(function(e){
    			 let quantityAvailable =/*[[${product.quantityAvailable}]]*/null;
    			 
    			 if(quantityAvailable < 1){
    				 $(".btns-quantity-detail-product").css('visibility','hidden');
     				 $(".btns-pay-or-not").css('visibility','hidden');
     				 $(".groups-buttom-cart-total").css('visibility','hidden');
    			 }

    			 function updateCostCurrent(){
    				let count = $("#count-order-product").val().trim();
    				let price = $("#count-order-product").data('price');
    				console.log(`"[updateCostCurrent())] count :${count}, price: ${price}"`);
    				count = Number(count);
    				price = Number(price);
    				
    				$("#cost-total-current").text(count * price);
    				console.log(`"[updateCostCurrent())] count current:${count * price}"`)
    			}

    			//우측 nav 메뉴 버튼들 관련
    			$("#btn-treat-menu-aside").on('click', function(){
    				location.href= "/product/product-list-view?category=treat"
    			})
    			$("#btn-kibble-menu-aside").on('click', function(){
    				location.href= "/product/product-list-view?category=kibble"
    			})
    			
				//현재 물품 수량 추가 버튼
				$("#btn-plus-quantity-current").on('click',function(){
					let count = $("#count-order-product").val();
					let number = Number(count);
					number += 1;
					count = String(number);
					$("#count-order-product").val(count);
					console.log(`count 1 added : ${$("#count-order-product").val()}`);
					
					//하단 가격 표시
					updateCostCurrent();
				}) // btn plus quantity current on click

				//현재 물품 수량 감소 버튼
				$("#btn-minus-quantity-current").on('click',function(){
					let count = $("#count-order-product").val();
					let number = Number(count);

					if(number < 1){
						return;
					}
					number -= 1;
					count = String(number);
					$("#count-order-product").val(count);
					console.log(`count 1 minused : ${$("#count-order-product").val()}`);
					
					//하단 가격 표시
					updateCostCurrent();
				})// btn minus quantity current on click
				
				//input #count-order-product 숫자 변경 되었을 때
				$("#count-order-product").on('keyup', function(){
					updateCostCurrent();
				}); //input #count-order-product on keyup
    			
				// btn-pay-product-current on click
    			$(".btn-pay-product-current").on('click', function(){
					let productId = $(this).data('product-id');
					let quantity = $("#count-order-product").val();
					console.log(quantity);
					if(quantity < 1){
						alert("상품 수량을 입력해 주세요");
						return;
					}
					url = "/invoice/payment-specific-item-view?productId=" + productId +"&quantity=" + quantity;
					console.log(`"[productDetail] product current directly go to payment page. productId = ${productId}, quantity = ${quantity}"`);
					location.href = url;
				})/*__end__ btn-pay-product-current on click */
    			
				
				//해당 물품 장바구니 추가 버튼
				$(".btn-add-to-cart").on('click', function(){
					let userId =/*[[${session.userId}]]*/null;
					if(!userId){
						alert("로그인 후 이용 가능합니다.");
						location.href="/user/sign-in-view"
						return;
					}
					
					let count = $("#count-order-product").val().trim();
					let number = Number(count);
					console.log(`count to add cart : ${number}`);
					
					if(number < 1){
						alert("상품 수량을 입력해 주세요");
						return;
					}
					//TODO count와 number가 숫자 형태로만 입력되었는지 체크해야

					let productId = $(this).data('product-id');
					let url = "/shopping-cart/update-quantity"
					console.log(url);
					let params = {"productId": productId
								,"quantity": count};
					console.log(`${productId}, ${count}`);


					$.post(url, params)
					.done(function(data){
						if(data.code == 200){
							//쇼핑카트 뷰로 이동; 로그인 상태에서만 이동 가능;
							location.href= "/shopping-cart/shopping-cart-view";
						} else if(data.code == 403){
							alert(data.error_message);
							location.href= "/user/sign-in-view";
						} else {
							console.log(data.error_message);
						}
					})// ajax
					
				})//btn add to cart on click
    			
    		})//document ready
    	
    	</script>
	</th:block>
	
</html>